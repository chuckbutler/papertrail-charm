#!/bin/bash


# Install Dependencies for Application Logging
# Install ruby 1.9.3 for latest -stable tree. 
# TODO: Ruby changes fairly often, make this configurable 
apt-get install -y ruby1.9.3 build-essential 

# Install papertrails application logging support
gem install remote_syslog --no-ri --no-rdoc

#its not unlikely that this will change in the future
declare endpoint="logs.papertrailapp.com"
declare port=`config-get port`
declare rsyslog_string="*.*    @$endpoint:$port"


# install rsyslog monitoring
	
if [ "$port" -eq "0" ]; then
 	juju-log "Papertrail not configured"
 	return 1
fi

if [ -a "/etc/rsyslog.d/25-papertrail.conf" ]; then 
    rm /etc/rsyslog.d/25-papertrail.conf
    juju-log "Removed stale papertrail configuration"
fi

echo "$rsyslog_string" >> /etc/rsyslog.d/25-papertrail.conf; 
juju-log "Updated Papertrail rsyslog support"


